KindEditor.plugin("table",function(n){var j=this,q="table",p=j.lang(q+"."),l="ke-zeroborder";function k(a,b){b=b.toUpperCase();a.css("background-color",b);a.css("color",b==="#000000"?"#FFFFFF":"#000000");a.html(b)}var m=[];function r(a,c){c.bind("click,mousedown",function(d){d.stopPropagation()});function b(){n.each(m,function(){this.remove()});m=[];n(document).unbind("click,mousedown",b);a.unbind("click,mousedown",b)}c.click(function(f){b();var g=n(this),e=g.pos();var d=n.colorpicker({x:e.x,y:e.y+g.height(),z:811214,selectedColor:n(this).html(),colors:j.colorTable,noColor:j.lang("noColor"),shadowMode:j.shadowMode,click:function(h){k(g,h);b()}});m.push(d);n(document).bind("click,mousedown",b);a.bind("click,mousedown",b)})}function o(f,e,c){var b=0;for(var a=0,d=e.cells.length;a<d;a++){if(e.cells[a]==c){break}b+=e.cells[a].rowSpan-1}return c.cellIndex-b}j.plugin.table={prop:function(g){var h=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+p.cells+"</label>",p.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',p.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+p.size+"</label>",p.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+p.percent+"</option>",'<option value="px">'+p.px+"</option>","</select> &nbsp; ",p.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+p.percent+"</option>",'<option value="px">'+p.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+p.space+"</label>",p.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',p.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+p.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+p.alignDefault+"</option>",'<option value="left">'+p.alignLeft+"</option>",'<option value="center">'+p.alignCenter+"</option>",'<option value="right">'+p.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+p.border+"</label>",p.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',p.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+p.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join("");var H=j.cmd.range.createBookmark();var b=j.createDialog({name:q,width:500,title:j.lang(q),body:h,beforeRemove:function(){J.unbind()},yesBtn:{name:j.lang("yes"),click:function(z){var t=M.val(),x=K.val(),Z=L.val(),u=E.val(),V=f.val(),X=D.val(),v=d.val(),y=c.val(),A=N.val(),W=F.val(),Y=n(J[0]).html()||"",w=n(J[1]).html()||"";if(t==0||!/^\d+$/.test(t)){alert(j.lang("invalidRows"));M[0].focus();return}if(x==0||!/^\d+$/.test(x)){alert(j.lang("invalidRows"));K[0].focus();return}if(!/^\d*$/.test(Z)){alert(j.lang("invalidWidth"));L[0].focus();return}if(!/^\d*$/.test(u)){alert(j.lang("invalidHeight"));E[0].focus();return}if(!/^\d*$/.test(v)){alert(j.lang("invalidPadding"));d[0].focus();return}if(!/^\d*$/.test(y)){alert(j.lang("invalidSpacing"));c[0].focus();return}if(!/^\d*$/.test(W)){alert(j.lang("invalidBorder"));F[0].focus();return}if(G){if(Z!==""){G.width(Z+V)}else{G.css("width","")}if(G[0].width!==undefined){G.removeAttr("width")}if(u!==""){G.height(u+X)}else{G.css("height","")}if(G[0].height!==undefined){G.removeAttr("height")}G.css("background-color",w);if(G[0].bgColor!==undefined){G.removeAttr("bgColor")}if(v!==""){G[0].cellPadding=v}else{G.removeAttr("cellPadding")}if(y!==""){G[0].cellSpacing=y}else{G.removeAttr("cellSpacing")}if(A!==""){G[0].align=A}else{G.removeAttr("align")}if(W!==""){G.attr("border",W)}else{G.removeAttr("border")}if(W===""||W==="0"){G.addClass(l)}else{G.removeClass(l)}if(Y!==""){G.attr("borderColor",Y)}else{G.removeAttr("borderColor")}j.hideDialog().focus();j.cmd.range.moveToBookmark(H);j.cmd.select();j.addBookmark();return}var s="";if(Z!==""){s+="width:"+Z+V+";"}if(u!==""){s+="height:"+u+X+";"}if(w!==""){s+="background-color:"+w+";"}var B="<table";if(s!==""){B+=' style="'+s+'"'}if(v!==""){B+=' cellpadding="'+v+'"'}if(y!==""){B+=' cellspacing="'+y+'"'}if(A!==""){B+=' align="'+A+'"'}if(W!==""){B+=' border="'+W+'"'}if(W===""||W==="0"){B+=' class="'+l+'"'}if(Y!==""){B+=' bordercolor="'+Y+'"'}B+=">";for(var C=0;C<t;C++){B+="<tr>";for(var U=0;U<x;U++){B+="<td>"+(n.IE?"&nbsp;":"<br />")+"</td>"}B+="</tr>"}B+="</table>";if(!n.IE){B+="<br />"}j.insertHtml(B);j.select().hideDialog().focus();j.addBookmark()}}}),e=b.div,M=n('[name="rows"]',e).val(3),K=n('[name="cols"]',e).val(2),L=n('[name="width"]',e).val(100),E=n('[name="height"]',e),f=n('[name="widthType"]',e),D=n('[name="heightType"]',e),d=n('[name="padding"]',e).val(2),c=n('[name="spacing"]',e).val(0),N=n('[name="align"]',e),F=n('[name="border"]',e).val(1),J=n(".ke-input-color",e);r(e,J.eq(0));r(e,J.eq(1));k(J.eq(0),"#000000");k(J.eq(1),"");M[0].focus();M[0].select();var G;if(g){return}G=j.plugin.getSelectedTable();if(G){M.val(G[0].rows.length);K.val(G[0].rows.length>0?G[0].rows[0].cells.length:0);M.attr("disabled",true);K.attr("disabled",true);var I,a=G[0].style.width||G[0].width,i=G[0].style.height||G[0].height;if(a!==undefined&&(I=/^(\d+)((?:px|%)*)$/.exec(a))){L.val(I[1]);f.val(I[2])}else{L.val("")}if(i!==undefined&&(I=/^(\d+)((?:px|%)*)$/.exec(i))){E.val(I[1]);D.val(I[2])}d.val(G[0].cellPadding||"");c.val(G[0].cellSpacing||"");N.val(G[0].align||"");F.val(G[0].border===undefined?"":G[0].border);k(J.eq(0),n.toHex(G.attr("borderColor")||""));k(J.eq(1),n.toHex(G[0].style.backgroundColor||G[0].bgColor||""));L[0].focus();L[0].select()}},cellprop:function(){var h=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+p.size+"</label>",p.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+p.percent+"</option>",'<option value="px">'+p.px+"</option>","</select> &nbsp; ",p.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+p.percent+"</option>",'<option value="px">'+p.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+p.align+"</label>",p.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+p.alignDefault+"</option>",'<option value="left">'+p.alignLeft+"</option>",'<option value="center">'+p.alignCenter+"</option>",'<option value="right">'+p.alignRight+"</option>","</select> ",p.verticalAlign+' <select name="verticalAlign">','<option value="">'+p.alignDefault+"</option>",'<option value="top">'+p.alignTop+"</option>",'<option value="middle">'+p.alignMiddle+"</option>",'<option value="bottom">'+p.alignBottom+"</option>",'<option value="baseline">'+p.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+p.border+"</label>",p.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',p.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+p.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join("");var G=j.cmd.range.createBookmark();var E=j.createDialog({name:q,width:500,title:j.lang("tablecell"),body:h,beforeRemove:function(){I.unbind()},yesBtn:{name:j.lang("yes"),click:function(y){var t=J.val(),u=C.val(),z=g.val(),B=i.val(),v=c.val(),x=a.val(),s=H.val(),O=e.val(),A=D.val(),P=n(I[0]).html()||"",w=n(I[1]).html()||"";if(!/^\d*$/.test(t)){alert(j.lang("invalidWidth"));J[0].focus();return}if(!/^\d*$/.test(u)){alert(j.lang("invalidHeight"));C[0].focus();return}if(!/^\d*$/.test(A)){alert(j.lang("invalidBorder"));D[0].focus();return}K.css({width:t!==""?(t+z):"",height:u!==""?(u+B):"","background-color":w,"text-align":s,"vertical-align":O,"border-width":A,"border-style":A!==""?"solid":"","border-color":P});j.hideDialog().focus();j.cmd.range.moveToBookmark(G);j.cmd.select();j.addBookmark()}}}),f=E.div,J=n('[name="width"]',f).val(100),C=n('[name="height"]',f),g=n('[name="widthType"]',f),i=n('[name="heightType"]',f),c=n('[name="padding"]',f).val(2),a=n('[name="spacing"]',f).val(0),H=n('[name="textAlign"]',f),e=n('[name="verticalAlign"]',f),D=n('[name="border"]',f).val(1),I=n(".ke-input-color",f);r(f,I.eq(0));r(f,I.eq(1));k(I.eq(0),"#000000");k(I.eq(1),"");J[0].focus();J[0].select();var K=j.plugin.getSelectedCell();var F,b=K[0].style.width||K[0].width||"",L=K[0].style.height||K[0].height||"";if((F=/^(\d+)((?:px|%)*)$/.exec(b))){J.val(F[1]);g.val(F[2])}else{J.val("")}if((F=/^(\d+)((?:px|%)*)$/.exec(L))){C.val(F[1]);i.val(F[2])}H.val(K[0].style.textAlign||"");e.val(K[0].style.verticalAlign||"");var d=K[0].style.borderWidth||"";if(d){d=parseInt(d)}D.val(d);k(I.eq(0),n.toHex(K[0].style.borderColor||""));k(I.eq(1),n.toHex(K[0].style.backgroundColor||""));J[0].focus();J[0].select()},insert:function(){this.prop(true)},"delete":function(){var a=j.plugin.getSelectedTable();j.cmd.range.setStartBefore(a[0]).collapse(true);j.cmd.select();a.remove();j.addBookmark()},colinsert:function(i){var c=j.plugin.getSelectedTable()[0],a=j.plugin.getSelectedRow()[0],d=j.plugin.getSelectedCell()[0],f=d.cellIndex+i;f+=c.rows[0].cells.length-a.cells.length;for(var g=0,e=c.rows.length;g<e;g++){var b=c.rows[g],h=b.insertCell(f);h.innerHTML=n.IE?"":"<br />";f=o(c,b,h)}j.cmd.range.selectNodeContents(d).collapse(true);j.cmd.select();j.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(e){var x=j.plugin.getSelectedTable()[0],h=j.plugin.getSelectedRow()[0],z=j.plugin.getSelectedCell()[0];var a=h.rowIndex;if(e===1){a=h.rowIndex+(z.rowSpan-1)+e}var i=x.insertRow(a);for(var c=0,b=h.cells.length;c<b;c++){if(h.cells[c].rowSpan>1){b-=h.cells[c].rowSpan-1}var d=i.insertCell(c);if(e===1&&h.cells[c].colSpan>1){d.colSpan=h.cells[c].colSpan}d.innerHTML=n.IE?"":"<br />"}for(var f=a;f>=0;f--){var y=x.rows[f].cells;if(y.length>c){for(var g=z.cellIndex;g>=0;g--){if(y[g].rowSpan>1){y[g].rowSpan+=1}}break}}j.cmd.range.selectNodeContents(z).collapse(true);j.cmd.select();j.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var g=j.plugin.getSelectedTable()[0],f=j.plugin.getSelectedRow()[0],d=j.plugin.getSelectedCell()[0],e=f.rowIndex,b=e+d.rowSpan,h=g.rows[b];if(g.rows.length<=b){return}var c=d.cellIndex;if(h.cells.length<=c){return}var a=h.cells[c];if(d.colSpan!==a.colSpan){return}d.rowSpan+=a.rowSpan;h.deleteCell(c);j.cmd.range.selectNodeContents(d).collapse(true);j.cmd.select();j.addBookmark()},colmerge:function(){var g=j.plugin.getSelectedTable()[0],f=j.plugin.getSelectedRow()[0],d=j.plugin.getSelectedCell()[0],e=f.rowIndex,b=d.cellIndex,c=b+1;if(f.cells.length<=c){return}var a=f.cells[c];if(d.rowSpan!==a.rowSpan){return}d.colSpan+=a.colSpan;f.deleteCell(c);j.cmd.range.selectNodeContents(d).collapse(true);j.cmd.select();j.addBookmark()},rowsplit:function(){var c=j.plugin.getSelectedTable()[0],a=j.plugin.getSelectedRow()[0],d=j.plugin.getSelectedCell()[0],e=a.rowIndex;if(d.rowSpan===1){return}var f=o(c,a,d);for(var h=1,g=d.rowSpan;h<g;h++){var b=c.rows[e+h],i=b.insertCell(f);if(d.colSpan>1){i.colSpan=d.colSpan}i.innerHTML=n.IE?"":"<br />";f=o(c,b,i)}n(d).removeAttr("rowSpan");j.cmd.range.selectNodeContents(d).collapse(true);j.cmd.select();j.addBookmark()},colsplit:function(){var g=j.plugin.getSelectedTable()[0],e=j.plugin.getSelectedRow()[0],c=j.plugin.getSelectedCell()[0],b=c.cellIndex;if(c.colSpan===1){return}for(var a=1,d=c.colSpan;a<d;a++){var f=e.insertCell(b+a);if(c.rowSpan>1){f.rowSpan=c.rowSpan}f.innerHTML=n.IE?"":"<br />"}n(c).removeAttr("colSpan");j.cmd.range.selectNodeContents(c).collapse(true);j.cmd.select();j.addBookmark()},coldelete:function(){var g=j.plugin.getSelectedTable()[0],e=j.plugin.getSelectedRow()[0],c=j.plugin.getSelectedCell()[0],a=c.cellIndex;for(var h=0,d=g.rows.length;h<d;h++){var b=g.rows[h],f=b.cells[a];if(f.colSpan>1){f.colSpan-=1;if(f.colSpan===1){n(f).removeAttr("colSpan")}}else{b.deleteCell(a)}if(f.rowSpan>1){h+=f.rowSpan-1}}if(e.cells.length===0){j.cmd.range.setStartBefore(g).collapse(true);j.cmd.select();n(g).remove()}else{j.cmd.selection(true)}j.addBookmark()},rowdelete:function(){var b=j.plugin.getSelectedTable()[0],a=j.plugin.getSelectedRow()[0],d=j.plugin.getSelectedCell()[0],e=a.rowIndex;for(var c=d.rowSpan-1;c>=0;c--){b.deleteRow(e+c)}if(b.rows.length===0){j.cmd.range.setStartBefore(b).collapse(true);j.cmd.select();n(b).remove()}else{j.cmd.selection(true)}j.addBookmark()}};j.clickToolbar(q,j.plugin.table.prop)});