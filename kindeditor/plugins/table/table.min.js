KindEditor.plugin("table",function(e){var i=this,b="table",c=i.lang(b+"."),g="ke-zeroborder";function h(k,j){j=j.toUpperCase();k.css("background-color",j);k.css("color",j==="#000000"?"#FFFFFF":"#000000");k.html(j)}var f=[];function a(l,j){j.bind("click,mousedown",function(m){m.stopPropagation()});function k(){e.each(f,function(){this.remove()});f=[];e(document).unbind("click,mousedown",k);l.unbind("click,mousedown",k)}j.click(function(o){k();var n=e(this),p=n.pos();var m=e.colorpicker({x:p.x,y:p.y+n.height(),z:811214,selectedColor:e(this).html(),colors:i.colorTable,noColor:i.lang("noColor"),shadowMode:i.shadowMode,click:function(q){h(n,q);k()}});f.push(m);e(document).bind("click,mousedown",k);l.bind("click,mousedown",k)})}function d(n,o,k){var l=0;for(var m=0,j=o.cells.length;m<j;m++){if(o.cells[m]==k){break}l+=o.cells[m].rowSpan-1}return k.cellIndex-l}i.plugin.table={prop:function(t){var s=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+c.cells+"</label>",c.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',c.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+c.size+"</label>",c.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+c.percent+"</option>",'<option value="px">'+c.px+"</option>","</select> &nbsp; ",c.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+c.percent+"</option>",'<option value="px">'+c.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+c.space+"</label>",c.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',c.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+c.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+c.alignDefault+"</option>",'<option value="left">'+c.alignLeft+"</option>",'<option value="center">'+c.alignCenter+"</option>",'<option value="right">'+c.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+c.border+"</label>",c.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',c.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+c.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join("");var p=i.cmd.range.createBookmark();var y=i.createDialog({name:b,width:500,title:i.lang(b),body:s,beforeRemove:function(){n.unbind()},yesBtn:{name:i.lang("yes"),click:function(N){var T=k.val(),P=m.val(),E=l.val(),S=B.val(),I=u.val(),G=r.val(),R=w.val(),O=x.val(),M=j.val(),H=q.val(),F=e(n[0]).html()||"",Q=e(n[1]).html()||"";if(T==0||!/^\d+$/.test(T)){alert(i.lang("invalidRows"));k[0].focus();return}if(P==0||!/^\d+$/.test(P)){alert(i.lang("invalidRows"));m[0].focus();return}if(!/^\d*$/.test(E)){alert(i.lang("invalidWidth"));l[0].focus();return}if(!/^\d*$/.test(S)){alert(i.lang("invalidHeight"));B[0].focus();return}if(!/^\d*$/.test(R)){alert(i.lang("invalidPadding"));w[0].focus();return}if(!/^\d*$/.test(O)){alert(i.lang("invalidSpacing"));x[0].focus();return}if(!/^\d*$/.test(H)){alert(i.lang("invalidBorder"));q[0].focus();return}if(A){if(E!==""){A.width(E+I)}else{A.css("width","")}if(A[0].width!==undefined){A.removeAttr("width")}if(S!==""){A.height(S+G)}else{A.css("height","")}if(A[0].height!==undefined){A.removeAttr("height")}A.css("background-color",Q);if(A[0].bgColor!==undefined){A.removeAttr("bgColor")}if(R!==""){A[0].cellPadding=R}else{A.removeAttr("cellPadding")}if(O!==""){A[0].cellSpacing=O}else{A.removeAttr("cellSpacing")}if(M!==""){A[0].align=M}else{A.removeAttr("align")}if(H!==""){A.attr("border",H)}else{A.removeAttr("border")}if(H===""||H==="0"){A.addClass(g)}else{A.removeClass(g)}if(F!==""){A.attr("borderColor",F)}else{A.removeAttr("borderColor")}i.hideDialog().focus();i.cmd.range.moveToBookmark(p);i.cmd.select();i.addBookmark();return}var D="";if(E!==""){D+="width:"+E+I+";"}if(S!==""){D+="height:"+S+G+";"}if(Q!==""){D+="background-color:"+Q+";"}var L="<table";if(D!==""){L+=' style="'+D+'"'}if(R!==""){L+=' cellpadding="'+R+'"'}if(O!==""){L+=' cellspacing="'+O+'"'}if(M!==""){L+=' align="'+M+'"'}if(H!==""){L+=' border="'+H+'"'}if(H===""||H==="0"){L+=' class="'+g+'"'}if(F!==""){L+=' bordercolor="'+F+'"'}L+=">";for(var K=0;K<T;K++){L+="<tr>";for(var J=0;J<P;J++){L+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>"}L+="</tr>"}L+="</table>";if(!e.IE){L+="<br />"}i.insertHtml(L);i.select().hideDialog().focus();i.addBookmark()}}}),v=y.div,k=e('[name="rows"]',v).val(3),m=e('[name="cols"]',v).val(2),l=e('[name="width"]',v).val(100),B=e('[name="height"]',v),u=e('[name="widthType"]',v),r=e('[name="heightType"]',v),w=e('[name="padding"]',v).val(2),x=e('[name="spacing"]',v).val(0),j=e('[name="align"]',v),q=e('[name="border"]',v).val(1),n=e(".ke-input-color",v);a(v,n.eq(0));a(v,n.eq(1));h(n.eq(0),"#000000");h(n.eq(1),"");k[0].focus();k[0].select();var A;if(t){return}A=i.plugin.getSelectedTable();if(A){k.val(A[0].rows.length);m.val(A[0].rows.length>0?A[0].rows[0].cells.length:0);k.attr("disabled",true);m.attr("disabled",true);var o,z=A[0].style.width||A[0].width,C=A[0].style.height||A[0].height;if(z!==undefined&&(o=/^(\d+)((?:px|%)*)$/.exec(z))){l.val(o[1]);u.val(o[2])}else{l.val("")}if(C!==undefined&&(o=/^(\d+)((?:px|%)*)$/.exec(C))){B.val(o[1]);r.val(o[2])}w.val(A[0].cellPadding||"");x.val(A[0].cellSpacing||"");j.val(A[0].align||"");q.val(A[0].border===undefined?"":A[0].border);h(n.eq(0),e.toHex(A.attr("borderColor")||""));h(n.eq(1),e.toHex(A[0].style.backgroundColor||A[0].bgColor||""));l[0].focus();l[0].select()}},cellprop:function(){var s=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+c.size+"</label>",c.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+c.percent+"</option>",'<option value="px">'+c.px+"</option>","</select> &nbsp; ",c.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+c.percent+"</option>",'<option value="px">'+c.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+c.align+"</label>",c.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+c.alignDefault+"</option>",'<option value="left">'+c.alignLeft+"</option>",'<option value="center">'+c.alignCenter+"</option>",'<option value="right">'+c.alignRight+"</option>","</select> ",c.verticalAlign+' <select name="verticalAlign">','<option value="">'+c.alignDefault+"</option>",'<option value="top">'+c.alignTop+"</option>",'<option value="middle">'+c.alignMiddle+"</option>",'<option value="bottom">'+c.alignBottom+"</option>",'<option value="baseline">'+c.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+c.border+"</label>",c.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',c.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+c.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join("");var o=i.cmd.range.createBookmark();var A=i.createDialog({name:b,width:500,title:i.lang("tablecell"),body:s,beforeRemove:function(){m.unbind()},yesBtn:{name:i.lang("yes"),click:function(J){var C=l.val(),N=B.val(),I=t.val(),G=r.val(),M=x.val(),K=z.val(),D=n.val(),F=v.val(),H=q.val(),E=e(m[0]).html()||"",L=e(m[1]).html()||"";if(!/^\d*$/.test(C)){alert(i.lang("invalidWidth"));l[0].focus();return}if(!/^\d*$/.test(N)){alert(i.lang("invalidHeight"));B[0].focus();return}if(!/^\d*$/.test(H)){alert(i.lang("invalidBorder"));q[0].focus();return}k.css({width:C!==""?(C+I):"",height:N!==""?(N+G):"","background-color":L,"text-align":D,"vertical-align":F,"border-width":H,"border-style":H!==""?"solid":"","border-color":E});i.hideDialog().focus();i.cmd.range.moveToBookmark(o);i.cmd.select();i.addBookmark()}}}),u=A.div,l=e('[name="width"]',u).val(100),B=e('[name="height"]',u),t=e('[name="widthType"]',u),r=e('[name="heightType"]',u),x=e('[name="padding"]',u).val(2),z=e('[name="spacing"]',u).val(0),n=e('[name="textAlign"]',u),v=e('[name="verticalAlign"]',u),q=e('[name="border"]',u).val(1),m=e(".ke-input-color",u);a(u,m.eq(0));a(u,m.eq(1));h(m.eq(0),"#000000");h(m.eq(1),"");l[0].focus();l[0].select();var k=i.plugin.getSelectedCell();var p,y=k[0].style.width||k[0].width||"",j=k[0].style.height||k[0].height||"";if((p=/^(\d+)((?:px|%)*)$/.exec(y))){l.val(p[1]);t.val(p[2])}else{l.val("")}if((p=/^(\d+)((?:px|%)*)$/.exec(j))){B.val(p[1]);r.val(p[2])}n.val(k[0].style.textAlign||"");v.val(k[0].style.verticalAlign||"");var w=k[0].style.borderWidth||"";if(w){w=parseInt(w)}q.val(w);h(m.eq(0),e.toHex(k[0].style.borderColor||""));h(m.eq(1),e.toHex(k[0].style.backgroundColor||""));l[0].focus();l[0].select()},insert:function(){this.prop(true)},"delete":function(){var j=i.plugin.getSelectedTable();i.cmd.range.setStartBefore(j[0]).collapse(true);i.cmd.select();j.remove();i.addBookmark()},colinsert:function(j){var p=i.plugin.getSelectedTable()[0],r=i.plugin.getSelectedRow()[0],o=i.plugin.getSelectedCell()[0],m=o.cellIndex+j;m+=p.rows[0].cells.length-r.cells.length;for(var l=0,n=p.rows.length;l<n;l++){var q=p.rows[l],k=q.insertCell(m);k.innerHTML=e.IE?"":"<br />";m=d(p,q,k)}i.cmd.range.selectNodeContents(o).collapse(true);i.cmd.select();i.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(n){var u=i.plugin.getSelectedTable()[0],w=i.plugin.getSelectedRow()[0],s=i.plugin.getSelectedCell()[0];var r=w.rowIndex;if(n===1){r=w.rowIndex+(s.rowSpan-1)+n}var v=u.insertRow(r);for(var p=0,q=w.cells.length;p<q;p++){if(w.cells[p].rowSpan>1){q-=w.cells[p].rowSpan-1}var o=v.insertCell(p);if(n===1&&w.cells[p].colSpan>1){o.colSpan=w.cells[p].colSpan}o.innerHTML=e.IE?"":"<br />"}for(var m=r;m>=0;m--){var t=u.rows[m].cells;if(t.length>p){for(var l=s.cellIndex;l>=0;l--){if(t[l].rowSpan>1){t[l].rowSpan+=1}}break}}i.cmd.range.selectNodeContents(s).collapse(true);i.cmd.select();i.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var o=i.plugin.getSelectedTable()[0],p=i.plugin.getSelectedRow()[0],j=i.plugin.getSelectedCell()[0],q=p.rowIndex,l=q+j.rowSpan,n=o.rows[l];if(o.rows.length<=l){return}var k=j.cellIndex;if(n.cells.length<=k){return}var m=n.cells[k];if(j.colSpan!==m.colSpan){return}j.rowSpan+=m.rowSpan;n.deleteCell(k);i.cmd.range.selectNodeContents(j).collapse(true);i.cmd.select();i.addBookmark()},colmerge:function(){var n=i.plugin.getSelectedTable()[0],o=i.plugin.getSelectedRow()[0],j=i.plugin.getSelectedCell()[0],p=o.rowIndex,l=j.cellIndex,k=l+1;if(o.cells.length<=k){return}var m=o.cells[k];if(j.rowSpan!==m.rowSpan){return}j.colSpan+=m.colSpan;o.deleteCell(k);i.cmd.range.selectNodeContents(j).collapse(true);i.cmd.select();i.addBookmark()},rowsplit:function(){var p=i.plugin.getSelectedTable()[0],r=i.plugin.getSelectedRow()[0],o=i.plugin.getSelectedCell()[0],n=r.rowIndex;if(o.rowSpan===1){return}var m=d(p,r,o);for(var k=1,l=o.rowSpan;k<l;k++){var q=p.rows[n+k],j=q.insertCell(m);if(o.colSpan>1){j.colSpan=o.colSpan}j.innerHTML=e.IE?"":"<br />";m=d(p,q,j)}e(o).removeAttr("rowSpan");i.cmd.range.selectNodeContents(o).collapse(true);i.cmd.select();i.addBookmark()},colsplit:function(){var n=i.plugin.getSelectedTable()[0],p=i.plugin.getSelectedRow()[0],k=i.plugin.getSelectedCell()[0],l=k.cellIndex;if(k.colSpan===1){return}for(var m=1,j=k.colSpan;m<j;m++){var o=p.insertCell(l+m);if(k.rowSpan>1){o.rowSpan=k.rowSpan}o.innerHTML=e.IE?"":"<br />"}e(k).removeAttr("colSpan");i.cmd.range.selectNodeContents(k).collapse(true);i.cmd.select();i.addBookmark()},coldelete:function(){var o=i.plugin.getSelectedTable()[0],q=i.plugin.getSelectedRow()[0],k=i.plugin.getSelectedCell()[0],m=k.cellIndex;for(var n=0,j=o.rows.length;n<j;n++){var l=o.rows[n],p=l.cells[m];if(p.colSpan>1){p.colSpan-=1;if(p.colSpan===1){e(p).removeAttr("colSpan")}}else{l.deleteCell(m)}if(p.rowSpan>1){n+=p.rowSpan-1}}if(q.cells.length===0){i.cmd.range.setStartBefore(o).collapse(true);i.cmd.select();e(o).remove()}else{i.cmd.selection(true)}i.addBookmark()},rowdelete:function(){var l=i.plugin.getSelectedTable()[0],m=i.plugin.getSelectedRow()[0],j=i.plugin.getSelectedCell()[0],n=m.rowIndex;for(var k=j.rowSpan-1;k>=0;k--){l.deleteRow(n+k)}if(l.rows.length===0){i.cmd.range.setStartBefore(l).collapse(true);i.cmd.select();e(l).remove()}else{i.cmd.selection(true)}i.addBookmark()}};i.clickToolbar(b,i.plugin.table.prop)});