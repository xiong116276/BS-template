KindEditor.plugin("table",function(e){var i=this,b="table",c=i.lang(b+"."),g="ke-zeroborder";function h(k,j){j=j.toUpperCase();k.css("background-color",j);k.css("color",j==="#000000"?"#FFFFFF":"#000000");k.html(j)}var f=[];function a(l,j){j.bind("click,mousedown",function(m){m.stopPropagation()});function k(){e.each(f,function(){this.remove()});f=[];e(document).unbind("click,mousedown",k);l.unbind("click,mousedown",k)}j.click(function(o){k();var n=e(this),p=n.pos();var m=e.colorpicker({x:p.x,y:p.y+n.height(),z:811214,selectedColor:e(this).html(),colors:i.colorTable,noColor:i.lang("noColor"),shadowMode:i.shadowMode,click:function(q){h(n,q);k()}});f.push(m);e(document).bind("click,mousedown",k);l.bind("click,mousedown",k)})}function d(n,o,k){var l=0;for(var m=0,j=o.cells.length;m<j;m++){if(o.cells[m]==k){break}l+=o.cells[m].rowSpan-1}return k.cellIndex-l}i.plugin.table={prop:function(s){var r=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keRows" style="width:90px;">'+c.cells+"</label>",c.rows+' <input type="text" id="keRows" class="ke-input-text ke-input-number" name="rows" value="" maxlength="4" /> &nbsp; ',c.cols+' <input type="text" class="ke-input-text ke-input-number" name="cols" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+c.size+"</label>",c.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+c.percent+"</option>",'<option value="px">'+c.px+"</option>","</select> &nbsp; ",c.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+c.percent+"</option>",'<option value="px">'+c.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="kePadding" style="width:90px;">'+c.space+"</label>",c.padding+' <input type="text" id="kePadding" class="ke-input-text ke-input-number" name="padding" value="" maxlength="4" /> &nbsp; ',c.spacing+' <input type="text" class="ke-input-text ke-input-number" name="spacing" value="" maxlength="4" />',"</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+c.align+"</label>",'<select id="keAlign" name="align">','<option value="">'+c.alignDefault+"</option>",'<option value="left">'+c.alignLeft+"</option>",'<option value="center">'+c.alignCenter+"</option>",'<option value="right">'+c.alignRight+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+c.border+"</label>",c.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',c.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+c.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join("");var x=i.createDialog({name:b,width:500,title:i.lang(b),body:r,beforeRemove:function(){n.unbind()},yesBtn:{name:i.lang("yes"),click:function(M){var S=k.val(),O=m.val(),D=l.val(),R=A.val(),H=t.val(),F=q.val(),Q=v.val(),N=w.val(),L=j.val(),G=p.val(),E=e(n[0]).html()||"",P=e(n[1]).html()||"";if(S==0||!/^\d+$/.test(S)){alert(i.lang("invalidRows"));k[0].focus();return}if(O==0||!/^\d+$/.test(O)){alert(i.lang("invalidRows"));m[0].focus();return}if(!/^\d*$/.test(D)){alert(i.lang("invalidWidth"));l[0].focus();return}if(!/^\d*$/.test(R)){alert(i.lang("invalidHeight"));A[0].focus();return}if(!/^\d*$/.test(Q)){alert(i.lang("invalidPadding"));v[0].focus();return}if(!/^\d*$/.test(N)){alert(i.lang("invalidSpacing"));w[0].focus();return}if(!/^\d*$/.test(G)){alert(i.lang("invalidBorder"));p[0].focus();return}if(z){if(D!==""){z.width(D+H)}else{z.css("width","")}if(z[0].width!==undefined){z.removeAttr("width")}if(R!==""){z.height(R+F)}else{z.css("height","")}if(z[0].height!==undefined){z.removeAttr("height")}z.css("background-color",P);if(z[0].bgColor!==undefined){z.removeAttr("bgColor")}if(Q!==""){z[0].cellPadding=Q}else{z.removeAttr("cellPadding")}if(N!==""){z[0].cellSpacing=N}else{z.removeAttr("cellSpacing")}if(L!==""){z[0].align=L}else{z.removeAttr("align")}if(G!==""){z.attr("border",G)}else{z.removeAttr("border")}if(G===""||G==="0"){z.addClass(g)}else{z.removeClass(g)}if(E!==""){z.attr("borderColor",E)}else{z.removeAttr("borderColor")}i.hideDialog().focus();return}var C="";if(D!==""){C+="width:"+D+H+";"}if(R!==""){C+="height:"+R+F+";"}if(P!==""){C+="background-color:"+P+";"}var K="<table";if(C!==""){K+=' style="'+C+'"'}if(Q!==""){K+=' cellpadding="'+Q+'"'}if(N!==""){K+=' cellspacing="'+N+'"'}if(L!==""){K+=' align="'+L+'"'}if(G!==""){K+=' border="'+G+'"'}if(G===""||G==="0"){K+=' class="'+g+'"'}if(E!==""){K+=' bordercolor="'+E+'"'}K+=">";for(var J=0;J<S;J++){K+="<tr>";for(var I=0;I<O;I++){K+="<td>"+(e.IE?"&nbsp;":"<br />")+"</td>"}K+="</tr>"}K+="</table>";if(!e.IE){K+="<br />"}i.insertHtml(K);i.select().hideDialog().focus();i.addBookmark()}}}),u=x.div,k=e('[name="rows"]',u).val(3),m=e('[name="cols"]',u).val(2),l=e('[name="width"]',u).val(100),A=e('[name="height"]',u),t=e('[name="widthType"]',u),q=e('[name="heightType"]',u),v=e('[name="padding"]',u).val(2),w=e('[name="spacing"]',u).val(0),j=e('[name="align"]',u),p=e('[name="border"]',u).val(1),n=e(".ke-input-color",u);a(u,n.eq(0));a(u,n.eq(1));h(n.eq(0),"#000000");h(n.eq(1),"");k[0].focus();k[0].select();var z;if(s){return}z=i.plugin.getSelectedTable();if(z){k.val(z[0].rows.length);m.val(z[0].rows.length>0?z[0].rows[0].cells.length:0);k.attr("disabled",true);m.attr("disabled",true);var o,y=z[0].style.width||z[0].width,B=z[0].style.height||z[0].height;if(y!==undefined&&(o=/^(\d+)((?:px|%)*)$/.exec(y))){l.val(o[1]);t.val(o[2])}else{l.val("")}if(B!==undefined&&(o=/^(\d+)((?:px|%)*)$/.exec(B))){A.val(o[1]);q.val(o[2])}v.val(z[0].cellPadding||"");w.val(z[0].cellSpacing||"");j.val(z[0].align||"");p.val(z[0].border===undefined?"":z[0].border);h(n.eq(0),e.toHex(z.attr("borderColor")||""));h(n.eq(1),e.toHex(z[0].style.backgroundColor||z[0].bgColor||""));l[0].focus();l[0].select()}},cellprop:function(){var r=['<div style="padding:20px;">','<div class="ke-dialog-row">','<label for="keWidth" style="width:90px;">'+c.size+"</label>",c.width+' <input type="text" id="keWidth" class="ke-input-text ke-input-number" name="width" value="" maxlength="4" /> &nbsp; ','<select name="widthType">','<option value="%">'+c.percent+"</option>",'<option value="px">'+c.px+"</option>","</select> &nbsp; ",c.height+' <input type="text" class="ke-input-text ke-input-number" name="height" value="" maxlength="4" /> &nbsp; ','<select name="heightType">','<option value="%">'+c.percent+"</option>",'<option value="px">'+c.px+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keAlign" style="width:90px;">'+c.align+"</label>",c.textAlign+' <select id="keAlign" name="textAlign">','<option value="">'+c.alignDefault+"</option>",'<option value="left">'+c.alignLeft+"</option>",'<option value="center">'+c.alignCenter+"</option>",'<option value="right">'+c.alignRight+"</option>","</select> ",c.verticalAlign+' <select name="verticalAlign">','<option value="">'+c.alignDefault+"</option>",'<option value="top">'+c.alignTop+"</option>",'<option value="middle">'+c.alignMiddle+"</option>",'<option value="bottom">'+c.alignBottom+"</option>",'<option value="baseline">'+c.alignBaseline+"</option>","</select>","</div>",'<div class="ke-dialog-row">','<label for="keBorder" style="width:90px;">'+c.border+"</label>",c.borderWidth+' <input type="text" id="keBorder" class="ke-input-text ke-input-number" name="border" value="" maxlength="4" /> &nbsp; ',c.borderColor+' <span class="ke-inline-block ke-input-color"></span>',"</div>",'<div class="ke-dialog-row">','<label for="keBgColor" style="width:90px;">'+c.backgroundColor+"</label>",'<span class="ke-inline-block ke-input-color"></span>',"</div>","</div>"].join("");var z=i.createDialog({name:b,width:500,title:i.lang("tablecell"),body:r,beforeRemove:function(){m.unbind()},yesBtn:{name:i.lang("yes"),click:function(I){var B=l.val(),M=A.val(),H=s.val(),F=q.val(),L=w.val(),J=y.val(),C=n.val(),E=u.val(),G=p.val(),D=e(m[0]).html()||"",K=e(m[1]).html()||"";if(!/^\d*$/.test(B)){alert(i.lang("invalidWidth"));l[0].focus();return}if(!/^\d*$/.test(M)){alert(i.lang("invalidHeight"));A[0].focus();return}if(!/^\d*$/.test(G)){alert(i.lang("invalidBorder"));p[0].focus();return}k.css({width:B!==""?(B+H):"",height:M!==""?(M+F):"","background-color":K,"text-align":C,"vertical-align":E,"border-width":G,"border-style":G!==""?"solid":"","border-color":D});i.hideDialog().focus();i.addBookmark()}}}),t=z.div,l=e('[name="width"]',t).val(100),A=e('[name="height"]',t),s=e('[name="widthType"]',t),q=e('[name="heightType"]',t),w=e('[name="padding"]',t).val(2),y=e('[name="spacing"]',t).val(0),n=e('[name="textAlign"]',t),u=e('[name="verticalAlign"]',t),p=e('[name="border"]',t).val(1),m=e(".ke-input-color",t);a(t,m.eq(0));a(t,m.eq(1));h(m.eq(0),"#000000");h(m.eq(1),"");l[0].focus();l[0].select();var k=i.plugin.getSelectedCell();var o,x=k[0].style.width||k[0].width||"",j=k[0].style.height||k[0].height||"";if((o=/^(\d+)((?:px|%)*)$/.exec(x))){l.val(o[1]);s.val(o[2])}else{l.val("")}if((o=/^(\d+)((?:px|%)*)$/.exec(j))){A.val(o[1]);q.val(o[2])}n.val(k[0].style.textAlign||"");u.val(k[0].style.verticalAlign||"");var v=k[0].style.borderWidth||"";if(v){v=parseInt(v)}p.val(v);h(m.eq(0),e.toHex(k[0].style.borderColor||""));h(m.eq(1),e.toHex(k[0].style.backgroundColor||""));l[0].focus();l[0].select()},insert:function(){this.prop(true)},"delete":function(){var j=i.plugin.getSelectedTable();i.cmd.range.setStartBefore(j[0]).collapse(true);i.cmd.select();j.remove();i.addBookmark()},colinsert:function(j){var p=i.plugin.getSelectedTable()[0],r=i.plugin.getSelectedRow()[0],o=i.plugin.getSelectedCell()[0],m=o.cellIndex+j;m+=p.rows[0].cells.length-r.cells.length;for(var l=0,n=p.rows.length;l<n;l++){var q=p.rows[l],k=q.insertCell(m);k.innerHTML=e.IE?"":"<br />";m=d(p,q,k)}i.cmd.range.selectNodeContents(o).collapse(true);i.cmd.select();i.addBookmark()},colinsertleft:function(){this.colinsert(0)},colinsertright:function(){this.colinsert(1)},rowinsert:function(n){var u=i.plugin.getSelectedTable()[0],w=i.plugin.getSelectedRow()[0],s=i.plugin.getSelectedCell()[0];var r=w.rowIndex;if(n===1){r=w.rowIndex+(s.rowSpan-1)+n}var v=u.insertRow(r);for(var p=0,q=w.cells.length;p<q;p++){if(w.cells[p].rowSpan>1){q-=w.cells[p].rowSpan-1}var o=v.insertCell(p);if(n===1&&w.cells[p].colSpan>1){o.colSpan=w.cells[p].colSpan}o.innerHTML=e.IE?"":"<br />"}for(var m=r;m>=0;m--){var t=u.rows[m].cells;if(t.length>p){for(var l=s.cellIndex;l>=0;l--){if(t[l].rowSpan>1){t[l].rowSpan+=1}}break}}i.cmd.range.selectNodeContents(s).collapse(true);i.cmd.select();i.addBookmark()},rowinsertabove:function(){this.rowinsert(0)},rowinsertbelow:function(){this.rowinsert(1)},rowmerge:function(){var o=i.plugin.getSelectedTable()[0],p=i.plugin.getSelectedRow()[0],j=i.plugin.getSelectedCell()[0],q=p.rowIndex,l=q+j.rowSpan,n=o.rows[l];if(o.rows.length<=l){return}var k=d(o,p,j);if(n.cells.length<=k){return}var m=n.cells[k];if(j.colSpan!==m.colSpan){return}j.rowSpan+=m.rowSpan;n.deleteCell(k);i.cmd.range.selectNodeContents(j).collapse(true);i.cmd.select();i.addBookmark()},colmerge:function(){var n=i.plugin.getSelectedTable()[0],o=i.plugin.getSelectedRow()[0],j=i.plugin.getSelectedCell()[0],p=o.rowIndex,l=j.cellIndex,k=l+1;if(o.cells.length<=k){return}var m=o.cells[k];if(j.rowSpan!==m.rowSpan){return}j.colSpan+=m.colSpan;o.deleteCell(k);i.cmd.range.selectNodeContents(j).collapse(true);i.cmd.select();i.addBookmark()},rowsplit:function(){var p=i.plugin.getSelectedTable()[0],r=i.plugin.getSelectedRow()[0],o=i.plugin.getSelectedCell()[0],n=r.rowIndex;if(o.rowSpan===1){return}var m=d(p,r,o);for(var k=1,l=o.rowSpan;k<l;k++){var q=p.rows[n+k],j=q.insertCell(m);if(o.colSpan>1){j.colSpan=o.colSpan}j.innerHTML=e.IE?"":"<br />";m=d(p,q,j)}e(o).removeAttr("rowSpan");i.cmd.range.selectNodeContents(o).collapse(true);i.cmd.select();i.addBookmark()},colsplit:function(){var n=i.plugin.getSelectedTable()[0],p=i.plugin.getSelectedRow()[0],k=i.plugin.getSelectedCell()[0],l=k.cellIndex;if(k.colSpan===1){return}for(var m=1,j=k.colSpan;m<j;m++){var o=p.insertCell(l+m);if(k.rowSpan>1){o.rowSpan=k.rowSpan}o.innerHTML=e.IE?"":"<br />"}e(k).removeAttr("colSpan");i.cmd.range.selectNodeContents(k).collapse(true);i.cmd.select();i.addBookmark()},coldelete:function(){var o=i.plugin.getSelectedTable()[0],q=i.plugin.getSelectedRow()[0],k=i.plugin.getSelectedCell()[0],m=k.cellIndex;for(var n=0,j=o.rows.length;n<j;n++){var l=o.rows[n],p=l.cells[m];if(p.colSpan>1){p.colSpan-=1;if(p.colSpan===1){e(p).removeAttr("colSpan")}}else{l.deleteCell(m)}if(p.rowSpan>1){n+=p.rowSpan-1}}if(q.cells.length===0){i.cmd.range.setStartBefore(o).collapse(true);i.cmd.select();e(o).remove()}else{i.cmd.selection(true)}i.addBookmark()},rowdelete:function(){var l=i.plugin.getSelectedTable()[0],m=i.plugin.getSelectedRow()[0],j=i.plugin.getSelectedCell()[0],n=m.rowIndex;for(var k=j.rowSpan-1;k>=0;k--){l.deleteRow(n+k)}if(l.rows.length===0){i.cmd.range.setStartBefore(l).collapse(true);i.cmd.select();e(l).remove()}else{i.cmd.selection(true)}i.addBookmark()}};i.clickToolbar(b,i.plugin.table.prop)});