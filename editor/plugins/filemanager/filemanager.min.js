KindEditor.plugin("filemanager",function(c){var d=this;var e="filemanager";var b=c.undef(d.fileManagerJson,d.basePath+"php/file_manager_json.php");var a=d.pluginsPath+e+"/images/";var f=d.lang(e+".");Date.prototype.format=function(h){var i={"M+":this.getMonth()+1,"d+":this.getDate(),"H+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};if(/(y+)/.test(h)){h=h.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))}for(var g in i){if(new RegExp("("+g+")").test(h)){h=h.replace(RegExp.$1,RegExp.$1.length==1?i[g]:("00"+i[g]).substr((""+i[g]).length))}}return h};d.plugin.filemanagerDialog=function(l){var v=c.undef(l.width,650);var t=c.undef(l.height,510);var i=c.undef(l.fileType,"");var y=c.undef(l.viewType,"view");var s=l.clickFn;var p=['<div style="padding:10px 20px;">','<div class="ke-plugin-filemanager-header">','<div class="ke-left">','<img class="ke-inline-block" name="moveupImg" src="'+a+'go-up.gif" width="16" height="16" border="0" alt="" /> ','<a class="ke-inline-block" name="moveupLink" href="javascript:;">'+f.moveup+"</a>","</div>",'<div class="ke-right">',f.viewType+' <select class="ke-inline-block" name="viewType">','<option value="view">'+f.viewImage+"</option>",'<option value="list">'+f.listImage+"</option>","</select> ",f.orderType+' <select class="ke-inline-block" name="orderType">','<option value="name">'+f.fileName+"</option>",'<option value="size">'+f.fileSize+"</option>",'<option value="type">'+f.fileType+"</option>","</select>","</div>",'<div class="ke-clearfix"></div>',"</div>",'<div class="ke-plugin-filemanager-body"></div>',"</div>"].join("");var w=d.createDialog({name:e,width:v,height:t,title:d.lang(e),body:p}),r=w.div,o=c(".ke-plugin-filemanager-body",r),n=c("[name='moveupImg']",r),A=c("[name='moveupLink']",r),u=c("[name='viewServer']",r),z=c("[name='viewType']",r),h=c("[name='orderType']",r);function q(D,B,C){var E="path="+D+"&fileType="+i+"&orderType="+B;w.showLoading(d.lang("ajaxLoading"));c.ajax(c.addParam(b,E+"&"+new Date().getTime()),function(F){w.hideLoading();C(D,F)})}var g=[];function k(C,F,D,B,E){if(B.isDirectory){C.click(function(G){q(F+B.name+"/",h.val(),E)})}else{C.click(function(G){s.call(this,B.url,B.name)})}g.push(C)}function m(F,D,E){c.each(g,function(){this.unbind()});A.unbind();z.unbind();h.unbind();if(F!="/"){var C=F.substr(0,F.replace(/\/$/,"").lastIndexOf("/")+1);A.click(function(G){q(C,h.val(),E)})}function B(){if(z.val()=="view"){q(F,h.val(),x)}else{q(F,h.val(),j)}}z.change(B);h.change(B);o.html("")}function j(J,C){m(J,C,j);var H=document.createElement("table");H.className="ke-table";H.cellPadding=0;H.cellSpacing=0;H.border=0;o.append(H);for(var D=0;D<C.length;D++){var F=C[D],I=c(H.insertRow(D));I.mouseover(function(K){c(this).addClass("ke-on")}).mouseout(function(K){c(this).removeClass("ke-on")});var B=a+(F.isDirectory?"folder-16.gif":"file-16.gif");var E=c('<img src="'+B+'" width="16" height="16" alt="'+F.name+'" align="absmiddle" />');var G=c(I[0].insertCell(0)).addClass("ke-cell ke-name").append(E).append(document.createTextNode(" "+F.name));I.css("cursor","pointer");G.attr("title",F.name);k(G,J,C,F,j);c(I[0].insertCell(1)).addClass("ke-cell ke-size").html(F.isDirectory?"-":Math.ceil(F.size/1024)+"KB");c(I[0].insertCell(2)).addClass("ke-cell ke-datetime").html(F.lastModified?new Date(F.lastModified).format("yyyy-MM-dd HH:mm"):"-")}}function x(H,G){m(H,G,x);for(var D=0;D<G.length;D++){var C=G[D];var I=c('<div class="ke-inline-block ke-item"></div>');o.append(I);var F=c('<div class="ke-inline-block ke-photo"></div>').mouseover(function(J){c(this).addClass("ke-on")}).mouseout(function(J){c(this).removeClass("ke-on")});I.append(F);var E=C.isDirectory?a+"folder-64.gif":(new RegExp("^\\S.*\\.(jpg|jpeg|bmp|gif|png)$","i").test(C.name)?C.url:a+"file-64.gif");var B=c('<img src="'+E+'" width="80" height="80" alt="'+C.name+'" />');F.css("cursor","pointer");F.attr("title",C.isDirectory?C.name:C.name+" ("+Math.ceil(C.size/1024)+"KB, "+new Date(C.lastModified).format("yyyy-MM-dd HH:mm")+")");k(F,H,G,C,x);F.append(B);I.append('<div class="ke-name" title="'+C.name+'">'+C.name+"</div>")}}z.val(y);q("/",h.val(),y=="view"?x:j);return w}});